name: Bump minor version

on: workflow_dispatch

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        ssh-key: "${{ secrets.PUSH_TAG_PRIVATE_KEY }}"

    - name: Get latest tag
      run: |
        git fetch --tags
        # This suppress an error occurred when the repository is a complete one.
        git fetch --prune --unshallow || true

        latest_tag=''

        # Get a latest tag in the shape of semver.
        for ref in $(git for-each-ref --sort=-creatordate --format '%(refname)' refs/tags); do
          tag="${ref#refs/tags/}"
          if echo "${tag}" | grep -Eq '^v?([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+[0-9A-Za-z-]+)?$'; then
            latest_tag="${tag}"
            break
          fi
        done

        if [ "${latest_tag}" = '' ]; then
          latest_tag="v0.0.0"
        fi

        echo "::set-output name=tag::${latest_tag}"

    - uses: actions-ecosystem/action-bump-semver@v1
      id: bump-semver
      with:
        current_version: ${{ steps.get-latest-tag.outputs.tag }}
        level: minor

    - uses: actions-ecosystem/action-push-tag@v1
      with:
        tag: ${{ steps.bump-semver.outputs.new_version }}
        message: '${{ steps.bump-semver.outputs.new_version }}'
